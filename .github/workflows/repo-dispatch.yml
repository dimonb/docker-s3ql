name: repo-dispatch

on:
  workflow_dispatch:

jobs:
  dispatch:
    strategy:
      matrix:
        branch: ['stable']
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-tags: true
      - id: get-tag
        run: |
          ls -l ${GITHUB_WORKSPACE}
          git -C ${GITHUB_WORKSPACE} log
          echo "TAG=$(git -C ${GITHUB_WORKSPACE} describe --abbrev=0)" >> $GITHUB_OUTPUT

      - id: run-build
        uses: benc-uk/workflow-dispatch@v1
        if: steps.get-tag.outputs.TAG != ''
        with:
          workflow: docker-build-publish
          ref: ${{steps.get-tag.outputs.TAG}}
